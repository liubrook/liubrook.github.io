<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png"><link rel="mask-icon" href="/images/logo.png" color="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=EB Garamond:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-mac-osx.min.css"><script src="/lib/pace/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"brookliu.xyz",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"always",padding:18,offset:12,onmobile:!0},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"./public/search.xml"}</script><meta name="description" content="前言在Docker简单上手01中我们一起学习了Docker的容器化。 在Docker简单上手02中我们一起学习了不同容器通过Docker网络实现相互之间的通信。"><meta property="og:type" content="article"><meta property="og:title" content="Docker简单上手03"><meta property="og:url" content="https://brookliu.xyz/2020/10/09/Docker%E7%AE%80%E5%8D%95%E4%B8%8A%E6%89%8B03/index.html"><meta property="og:site_name" content="1024肥宅"><meta property="og:description" content="前言在Docker简单上手01中我们一起学习了Docker的容器化。 在Docker简单上手02中我们一起学习了不同容器通过Docker网络实现相互之间的通信。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img.brookliu.xyz/blog/docker-3-1.png"><meta property="og:image" content="https://static.tuture.co/c/442cc8d/170b032e4bd0e059.png"><meta property="og:image" content="https://img.brookliu.xyz/blog/docker-3-2.png"><meta property="og:image" content="https://img.brookliu.xyz/blog/docker-3-3.png"><meta property="article:published_time" content="2020-10-09T02:58:00.000Z"><meta property="article:modified_time" content="2020-10-09T06:33:17.000Z"><meta property="article:author" content="Brookliu"><meta property="article:tag" content="Docker"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.brookliu.xyz/blog/docker-3-1.png"><link rel="canonical" href="https://brookliu.xyz/2020/10/09/Docker%E7%AE%80%E5%8D%95%E4%B8%8A%E6%89%8B03/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>Docker简单上手03 | 1024肥宅</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="1024肥宅" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a href="https://github.com/liubrook" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">1024肥宅</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> 标签<span class="badge">22</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> 分类<span class="badge">18</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档<span class="badge">65</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div> <a href="https://github.com/liubrook" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://brookliu.xyz/2020/10/09/Docker%E7%AE%80%E5%8D%95%E4%B8%8A%E6%89%8B03/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/logo.png"><meta itemprop="name" content="Brookliu"><meta itemprop="description" content="扶我起来，我还能写"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="1024肥宅"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Docker简单上手03</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-10-09 10:58:00 / 修改时间：14:33:17" itemprop="dateCreated datePublished" datetime="2020-10-09T10:58:00+08:00">2020-10-09</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a></span></span><span id="/2020/10/09/Docker%E7%AE%80%E5%8D%95%E4%B8%8A%E6%89%8B03/" class="post-meta-item leancloud_visitors" data-flag-title="Docker简单上手03" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span> <span>℃</span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/2020/10/09/Docker%E7%AE%80%E5%8D%95%E4%B8%8A%E6%89%8B03/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2020/10/09/Docker%E7%AE%80%E5%8D%95%E4%B8%8A%E6%89%8B03/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在<a href="https://brookliu.xyz/2020/10/07/Docker%E7%AE%80%E5%8D%95%E4%B8%8A%E6%89%8B01/#more">Docker简单上手01</a>中我们一起学习了Docker的容器化。</p><p>在<a href="https://brookliu.xyz/2020/10/08/Docker%E7%AE%80%E5%8D%95%E4%B8%8A%E6%89%8B02/">Docker简单上手02</a>中我们一起学习了不同容器通过Docker网络实现相互之间的通信。</p><a id="more"></a><h3 id="Docker数据管理"><a href="#Docker数据管理" class="headerlink" title="Docker数据管理"></a>Docker数据管理</h3><p>今天我们一起学习上手Docker数据管理。Docker数据的管理方式主要分为三种：</p><ul><li>数据卷(Volume)，也是最为推荐的一种方式。</li><li>绑定挂载(Bind Mount)，Docker早期常用的数据管理方式。</li><li>tmpfs挂载。基于内存的数据管理。</li></ul><div class="note info"><p>注意</p><a href="https://docs.docker.com/storage/tmpfs/" target="_blank" rel="noopener">tmpfs挂载</a>只适用于Linux操作系统。</div><h4 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h4><h5 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h5><p>数据卷（Volume）也是常见的 Docker 对象类型的一种，因此也支持 create（创建）、inspect （查看详情）、ls （列出所有数据卷）、prune （删除无用数据卷）和 rm（删除）等操作。<br>首先创建一个数据卷：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create my-volume</span><br></pre></td></tr></table></figure><p>查看当前所有的数据卷</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume ls</span><br></pre></td></tr></table></figure><p>可以看到输出的信息最后一条</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local               my-volume</span><br></pre></td></tr></table></figure><p>然后我们输入命令查看my-volume数据卷的详细情况：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume inspect my-volume</span><br></pre></td></tr></table></figure><p>可以看到输出了下面的信息：<br><img src="https://img.brookliu.xyz/blog/docker-3-1.png" alt="my-volume信息"></p><p>最后我们删除刚才创建的my-volume数据卷</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume rm my-volume</span><br></pre></td></tr></table></figure><p><img src="https://static.tuture.co/c/442cc8d/170b032e4bd0e059.png" alt="数据卷"><br>从上图我们可以看到，数据卷在 “主机环境” 和 “容器环境” 之间架起了 “一道桥梁”。通常，我们在容器中将需要存储的数据写入数据卷所挂载的路径（位置），然后就会立即、自动地将这些数据存储到主机对应的区域。</p><h5 id="创建数据卷的方式"><a href="#创建数据卷的方式" class="headerlink" title="创建数据卷的方式"></a>创建数据卷的方式</h5><p>在创建带有数据卷的容器时，通常有两种选择：1）命名卷（Named Volume）；2）匿名卷（Anonymous Volume）。接下来我们就分别详细讲解。</p><h6 id="创建命名卷"><a href="#创建命名卷" class="headerlink" title="创建命名卷"></a>创建命名卷</h6><p>运行以下命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rum -it -v my:vol:&#x2F;data --name container1 alpine</span><br></pre></td></tr></table></figure><p>可以看到，我们通过 -v （或者 –volume ）参数指定了数据卷的配置为 my-vol:/data ，其中（你应该猜到了）my-vol 就是数据卷的名称，/data 就是容器中数据卷的路径。</p><p>在进入容器后，向/data目录中添加一个文件后退出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch &#x2F;data&#x2F;file.txt</span><br><span class="line">exit</span><br></pre></td></tr></table></figure><p>为了验证 /data 中的数据是否真的保存下来，我们删除 container1 容器，然后再创建一个新的容器 container2 ，查看其中的 /data 目录内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker rm container1</span><br><span class="line"></span><br><span class="line">docker run -it -v my-vol:&#x2F;data --name container2 alpine</span><br><span class="line"></span><br><span class="line">ls &#x2F;data</span><br><span class="line">&#x2F;&#x2F; 这里可以看到会输出</span><br><span class="line">file.txt</span><br><span class="line"></span><br><span class="line">exit</span><br></pre></td></tr></table></figure><p>可以看到刚刚在 container1 中创建的 file.txt 文件！事实上，这种在容器之间共享数据卷的模式非常常见，Docker 提供了一个方便的参数 –volumes-from 来轻松实现数据卷共享：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v --volumes-from container2 --name container3 alpine</span><br><span class="line"></span><br><span class="line">ls &#x2F;data</span><br><span class="line">file.txt</span><br></pre></td></tr></table></figure><p>同样，container3 中也能访问到数据卷中的内容。</p><h6 id="创建匿名卷"><a href="#创建匿名卷" class="headerlink" title="创建匿名卷"></a>创建匿名卷</h6><p>创建匿名卷的方式就很简单了，之前我们通过 my-vol:/data 作为 -v 的参数，而创建匿名卷只需省略数据卷名称（my-vol 即可）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v &#x2F;data --name container4 alpine</span><br></pre></td></tr></table></figure><p>输入以下命令查看container4的情况：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect container4</span><br></pre></td></tr></table></figure><p><img src="https://img.brookliu.xyz/blog/docker-3-2.png" alt="container4"></p><p>看一下Mount中的一些重要字段：</p><ul><li>Name 即数据卷的名称，由于是匿名卷，所以 Name 字段就是一串长长的随机数，命名卷则为指定的名称。</li><li>Source 为数据卷在主机文件系统中的存储路径（之前说了，Windows 和 Mac 在 Docker 虚拟机中）。</li><li>Destination 为数据卷在容器中的挂载点。</li><li>RW 指可读写（Read-Write），如果为 false ，则为只读数据卷。</li></ul><h5 id="在-Dockerfile-中使用数据卷"><a href="#在-Dockerfile-中使用数据卷" class="headerlink" title="在 Dockerfile 中使用数据卷"></a>在 Dockerfile 中使用数据卷</h5><p>在 Dockerfile 中使用数据卷非常简单，只需通过 VOLUME 关键词指定数据卷就可以了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">VOLUME &#x2F;data</span><br><span class="line"></span><br><span class="line"># 或者通过 JSON 数组的方式指定多个数据卷</span><br><span class="line">VOLUME [&quot;&#x2F;data1&quot;, &quot;&#x2F;data2&quot;, &quot;&#x2F;data3&quot;]</span><br></pre></td></tr></table></figure><div class="note warning"><p>注意</p><p>只能创建匿名卷</p><p>当通过docker run -v指定数据卷时，Dockerfile中的配置会被覆盖</p></div><h4 id="绑定挂载"><a href="#绑定挂载" class="headerlink" title="绑定挂载"></a>绑定挂载</h4><p>绑定挂载（Bind Mount）是出现最早的 Docker 数据管理和存储解决方案，它的大致思路和数据卷是一致的，只不过是直接建立本机文件系统和容器文件系统之间的映射关系，非常适合简单、灵活地在本机和容器之间传递数据。</p><p>我们可以试着把自己机器的桌面（或者其他路径）挂载到容器中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm -v ~&#x2F;Desktop:&#x2F;desktop alpine</span><br></pre></td></tr></table></figure><p>我们还是通过 -v 参数来进行配置，<del>/Desktop 是本机文件系统路径，/desktop 则是容器中的路径，</del>/Desktop:/desktop 则是将本机路径和容器路径进行绑定，仿佛架起了一道桥梁。这里的 –rm 选项是指在容器停止之后自动删除。</p><p>进入到容器之后，可以试试看 /desktop 下面有没有自己桌面上的东西，然后再在容器中创建一个文件，看看桌面上有没有收到这个文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;# ls &#x2F;desktop</span><br><span class="line"></span><br><span class="line">&#x2F;# touch &#x2F;desktop&#x2F;from-container.txt</span><br></pre></td></tr></table></figure><p>你应该能看到自己的桌面上多了容器中创建的 from-container.txt 文件！</p><h3 id="动手实战"><a href="#动手实战" class="headerlink" title="动手实战"></a>动手实战</h3><p>上面我们熟悉了Docker数据管理的两种方式，说不如练，下面我们直接动手演示。</p><h4 id="项目准备"><a href="#项目准备" class="headerlink" title="项目准备"></a>项目准备</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone -b volume-start https:&#x2F;&#x2F;github.com&#x2F;tuture-dev&#x2F;docker-dream.git</span><br><span class="line">cd docker-dream</span><br></pre></td></tr></table></figure><p>实战内容：</p><ul><li>存储和备份 Express 服务器输出的日志数据，而不是存储在” 朝生暮死 “的容器中。</li><li>MongoDB 镜像已经做了数据卷配置，所以我们只需实践一波怎么备份和恢复数据。</li></ul><h4 id="为-Express-服务器挂载数据卷"><a href="#为-Express-服务器挂载数据卷" class="headerlink" title="为 Express 服务器挂载数据卷"></a>为 Express 服务器挂载数据卷</h4><p>我们首先在 server/Dockerfile 中添加 VOLUME 配置，并且指定 LOG_PATH （日志输出路径环境变量，可参考 server/index.js 的源码）为 /var/log/server/access.log，代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">FROM node:10</span><br><span class="line"></span><br><span class="line"># 指定工作目录为 &#x2F;usr&#x2F;src&#x2F;app，接下来的命令全部在这个目录下操作</span><br><span class="line">WORKDIR &#x2F;usr&#x2F;src&#x2F;app</span><br><span class="line"></span><br><span class="line">VOLUME &#x2F;var&#x2F;log&#x2F;server</span><br><span class="line"></span><br><span class="line"># 将 package.json 拷贝到工作目录</span><br><span class="line">COPY package.json .</span><br><span class="line"></span><br><span class="line"># 安装 npm 依赖</span><br><span class="line">RUN npm config set registry https:&#x2F;&#x2F;registry.npm.taobao.org &amp;&amp; npm install</span><br><span class="line"></span><br><span class="line"># 拷贝源代码</span><br><span class="line">COPY . .</span><br><span class="line"></span><br><span class="line"># 设置环境变量（服务器的主机 IP 和端口）</span><br><span class="line">ENV MONGO_URI&#x3D;mongodb:&#x2F;&#x2F;dream-db:27017&#x2F;todos</span><br><span class="line">ENV HOST&#x3D;0.0.0.0</span><br><span class="line">ENV PORT&#x3D;4000</span><br><span class="line">ENV LOG_PATH&#x3D;&#x2F;var&#x2F;log&#x2F;server&#x2F;access.log</span><br><span class="line"></span><br><span class="line"># 开放 4000 端口</span><br><span class="line">EXPOSE 4000</span><br><span class="line"></span><br><span class="line"># 设置镜像运行命令</span><br><span class="line">CMD [ &quot;node&quot;, &quot;index.js&quot; ]</span><br></pre></td></tr></table></figure><p>然后 build 服务器镜像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t dream-server server&#x2F;</span><br></pre></td></tr></table></figure><p>现在我们把整个项目走起来，也就是进来前两篇文章的内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 创建网络，便于容器互联</span><br><span class="line">docker network create dream-net</span><br><span class="line"></span><br><span class="line"># 启动 MongoDB 容器（dream-db）</span><br><span class="line">docker run --name dream-db --network dream-net -d mongo</span><br><span class="line"></span><br><span class="line"># 启动 Express API 容器（dream-api）</span><br><span class="line">docker run -p 4000:4000 --name dream-api --network dream-net -d dream-server</span><br><span class="line"></span><br><span class="line"># 构建提供 React 前端页面的 Nginx 服务器</span><br><span class="line">docker build -t dream-client client</span><br><span class="line"></span><br><span class="line"># 启动 Nginx 服务器容器（client）</span><br><span class="line">docker run -p 8080:80 --name client -d dream-client</span><br></pre></td></tr></table></figure><p>项目起来之后我们<code>docker ps</code>确保三个容器都已经开启:<br><img src="https://img.brookliu.xyz/blog/docker-3-3.png" alt="容器开启"></p><p>然后访问localhost:8080(服务器域名:8080)</p><h4 id="日志数据的备份"><a href="#日志数据的备份" class="headerlink" title="日志数据的备份"></a>日志数据的备份</h4><p>创建一个新的临时容器，通过共享数据卷的方式来备份数据。</p><ul><li><p>实现 dream-api 容器和数据卷之间的数据共享（已实现）。</p></li><li><p>创建临时容器，获取 dream-api 的数据卷。运行以下命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm --volumes-from dream-api -v $(pwd):&#x2F;backup alpine</span><br></pre></td></tr></table></figure><div class="note info"><p>上面这句命令同时用到了上面讲解的数据卷和绑定挂载：</p><p>--volumes-from dream-api 用于容器之间共享数据卷，这里我们获取 dream-api 的数据卷</p><p>-v $(pwd):/backup 用于建立当前本机文件路径（pwd 命令获取）和临时容器内 /backup 路径的绑定挂载</p></div><ul><li>进入临时容器之后，我们把日志数据压缩成 tar 包放到 /backup 目录下，然后退出：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F; # tar cvf &#x2F;backup&#x2F;backup.tar &#x2F;var&#x2F;log&#x2F;server&#x2F;</span><br><span class="line">tar: removing leading &#39;&#x2F;&#39; from member names</span><br><span class="line">var&#x2F;log&#x2F;server&#x2F;</span><br><span class="line">var&#x2F;log&#x2F;server&#x2F;access.log</span><br><span class="line">&#x2F; # exit</span><br></pre></td></tr></table></figure></li></ul></li></ul><p>退出之后用下面的命令在当前目录查看日志的备份backup.tar</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm --volumes-from dream-api -v $(pwd):&#x2F;backup alpine tar cvf &#x2F;backup&#x2F;backup.tar &#x2F;var&#x2F;log&#x2F;server</span><br></pre></td></tr></table></figure><h4 id="数据库备份与恢复"><a href="#数据库备份与恢复" class="headerlink" title="数据库备份与恢复"></a>数据库备份与恢复</h4><div class="note info"><p>提示</p><p>我们这里使用 MongoDB 自带的备份与恢复命令（mongodump 与 mongorestore ），其他数据库（例如 MySQL）也有类似的命令，都可以借鉴本文的方式。</p></div><h5 id="临时容器-容器互联"><a href="#临时容器-容器互联" class="headerlink" title="临时容器 + 容器互联"></a>临时容器 + 容器互联</h5><p>首先，我们的临时容器得连接上 dream-db 容器，并配置好绑定挂载，命令如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm -v $(pwd):&#x2F;backup --network dream-net mongo sh</span><br></pre></td></tr></table></figure><p>和之前备份日志数据相比，我们要把这个临时容器连接到 dream-net 网络中，它才能访问到 dream-db 的数据进行备份。</p><p>第二步，进入到这个临时容器后，运行 mongodump 命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F; # mongodump -v --host dream-db:27017 --archive --gzip &gt; &#x2F;backup&#x2F;mongo-backup.gz</span><br></pre></td></tr></table></figure><p>此时，由于绑定挂载，输出到 /backup 的文件将保存到当前目录（pwd）中。退出后，就可以在当前目录下看到 mongo-backup.gz 文件了。</p><h5 id="提前做好绑定挂载"><a href="#提前做好绑定挂载" class="headerlink" title="提前做好绑定挂载"></a>提前做好绑定挂载</h5><p>在创建数据库容器的时候，运行以下命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name dream-db --network dream-net -v $(pwd):&#x2F;backup -d mongo</span><br></pre></td></tr></table></figure><p>然后再通过 docker exec 执行 mongodump 命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec dream-db sh -c &#39;mongodump -v --archive --gzip &gt; &#x2F;backup&#x2F;mongo-backup.gz&#39;</span><br></pre></td></tr></table></figure><p>这样就可以实现创建数据库容器的时候就做好绑定挂载，然后通过 mongodump 把数据备份到挂载区域.这里我们用 sh -c 来执行一整条 Shell 命令（字符串形式），这样避免了重定向符 &gt; 引发的歧义（不理解的话可以把 sh -c ‘xxx’ 替换成 xxx）。可以看到，mongodump 的命令简单了许多，我们再也不需要指定 –host 参数，因为数据库就在本容器内。</p><p><font color="red">但是有个问题：如果已经创建了数据库，并且没有提前做绑定挂载，这种方法就行不通了！</font></p><h2><font color="red">注意，这不是演习！</font></h2><p>有了数据库备份文件，我们就可以肆无忌惮地来做一波” 演习 “了。通过以下命令，直接端了目前的数据库和 API 服务器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker rm -f --volumes dream-db</span><br><span class="line">docker rm -f dream-api</span><br></pre></td></tr></table></figure><p>没错，通过 –volumes 开关，我们不仅把 dream-db 容器删了，还顺带把挂载的数据卷全部删除！演习就是要足够逼真才行。这时候再访问 localhost:8080 ，之前的待办数据全部丢失！</p><p>现在让我们再次创建新的 dream-db 容器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name dream-db --network dream-net -v $(pwd):&#x2F;backup -d mongo</span><br></pre></td></tr></table></figure><p>注意到，我们通过绑定挂载的方式把当前目录映射到容器的 /backup 目录，这意味着可以在这个新的容器中通过 /backup/mongo-backup.gz 来恢复数据，运行以下命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec dream-db sh -c &#39;mongorestore --archive --gzip &lt; &#x2F;backup&#x2F;mongo-backup.gz&#39;</span><br></pre></td></tr></table></figure><p>我们应该会看到输出了一些日志，提示我们数据恢复成功。最后重新开启 API 服务器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 4000:4000 --name dream-api --network dream-net -d dream-server</span><br></pre></td></tr></table></figure><p>现在再次访问应用是不是发现数据都找回来了！</p><p>今天的docker上手到这里就结束了，共勉加油！</p><p>教程：<a href="https://tuture.co/2020/03/06/0X8ssR3/" target="_blank" rel="noopener">图灵社区：上手容器数据管理</a></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> Brookliu</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://brookliu.xyz/2020/10/09/Docker%E7%AE%80%E5%8D%95%E4%B8%8A%E6%89%8B03/" title="Docker简单上手03">https://brookliu.xyz/2020/10/09/Docker简单上手03/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Docker/" rel="tag"><i class="fa fa-tag"></i> # Docker</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2020/10/08/Docker%E7%AE%80%E5%8D%95%E4%B8%8A%E6%89%8B02/" rel="prev" title="Docker简单上手02"><i class="fa fa-chevron-left"></i> Docker简单上手02</a></div><div class="post-nav-item"> <a href="/2020/10/09/Hexo%E5%86%99%E4%BD%9C%E6%A0%B7%E5%BC%8F%E7%AE%80%E4%BB%8B/" rel="next" title="Hexo写作样式简介">Hexo写作样式简介<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker数据管理"><span class="nav-number">2.</span> <span class="nav-text">Docker数据管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#数据卷"><span class="nav-number">2.1.</span> <span class="nav-text">数据卷</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#基本命令"><span class="nav-number">2.1.1.</span> <span class="nav-text">基本命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建数据卷的方式"><span class="nav-number">2.1.2.</span> <span class="nav-text">创建数据卷的方式</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#创建命名卷"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">创建命名卷</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#创建匿名卷"><span class="nav-number">2.1.2.2.</span> <span class="nav-text">创建匿名卷</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在-Dockerfile-中使用数据卷"><span class="nav-number">2.1.3.</span> <span class="nav-text">在 Dockerfile 中使用数据卷</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#绑定挂载"><span class="nav-number">2.2.</span> <span class="nav-text">绑定挂载</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动手实战"><span class="nav-number">3.</span> <span class="nav-text">动手实战</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#项目准备"><span class="nav-number">3.1.</span> <span class="nav-text">项目准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#为-Express-服务器挂载数据卷"><span class="nav-number">3.2.</span> <span class="nav-text">为 Express 服务器挂载数据卷</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#日志数据的备份"><span class="nav-number">3.3.</span> <span class="nav-text">日志数据的备份</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据库备份与恢复"><span class="nav-number">3.4.</span> <span class="nav-text">数据库备份与恢复</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#临时容器-容器互联"><span class="nav-number">3.4.1.</span> <span class="nav-text">临时容器 + 容器互联</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#提前做好绑定挂载"><span class="nav-number">3.4.2.</span> <span class="nav-text">提前做好绑定挂载</span></a></li></ol></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#"><span class="nav-number"></span> <span class="nav-text">注意，这不是演习！</span></a></li></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Brookliu" src="/images/logo.png"><p class="site-author-name" itemprop="name">Brookliu</p><div class="site-description" itemprop="description">扶我起来，我还能写</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">65</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">18</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">22</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/liubrook" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;liubrook" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://juejin.im/user/588993964030574" title="掘金 → https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;588993964030574" rel="noopener" target="_blank"><i class="fa fa-spinner fa-fw"></i> 掘金</a></span><span class="links-of-author-item"><a href="https://blog.csdn.net/lqpf199681" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;lqpf199681" rel="noopener" target="_blank"><i class="fa fa-crossjairs fa-fw"></i> CSDN</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://www.zhangxinxu.com/" title="http:&#x2F;&#x2F;www.zhangxinxu.com&#x2F;" rel="noopener" target="_blank">张鑫旭</a></li><li class="links-of-blogroll-item"> <a href="http://www.alloyteam.com/nav/" title="http:&#x2F;&#x2F;www.alloyteam.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">Web前端导航</a></li><li class="links-of-blogroll-item"> <a href="http://ife.baidu.com/" title="http:&#x2F;&#x2F;ife.baidu.com&#x2F;" rel="noopener" target="_blank">百度前端技术学院</a></li><li class="links-of-blogroll-item"> <a href="http://wf.uisdc.com/cn/" title="http:&#x2F;&#x2F;wf.uisdc.com&#x2F;cn&#x2F;" rel="noopener" target="_blank">google前端开发基础</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright"> &copy; 2019 – <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-star"></i></span> <span class="author" itemprop="copyrightHolder">by 1024肥宅</span></div><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_uv">本站访客数:<span id="busuanzi_value_site_uv"></span></span></div><div class="addthis_inline_share_toolbox"><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5fb642a4fe3376d3" async="async"></script></div><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共140.5k字</span></div><div class="weixin-box"><div class="weixin-menu"><div class="weixin-hover"><div class="weixin-description">微信扫一扫，订阅本博客</div></div></div></div><style>#comments .veditor{min-height:10rem;background-image:url(https://gitee.com/wugenqiang/PictureBed/raw/master/CS-Notes/20200425091751.png);background-size:contain;background-repeat:no-repeat;background-position:right;background-color:rgba(255,255,255,0);resize:none}</style><script>
    //   自定义邮箱审核规则
    document.body.addEventListener('click', function(e) {
        if (e.target.classList.contains('vsubmit')) {
            const email = document.querySelector('input[type=email]');
            const nick = document.querySelector('input[name=nick]');
            const reg = /^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
            if (!email.value || !nick.value || !reg.test(email.value)) {
                const str = `<div class="valert text-center"><div class="vtext">请填写正确的昵称和邮箱！</div></div>`;
                const vmark = document.querySelector('.vmark');
                vmark.innerHTML = str;
                vmark.style.display = 'block';
                setTimeout(function() {
                    vmark.style.display = 'none';
                    vmark.innerHTML = '';
                }, 2500);
            }
        }
    })
</script><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"wdEmjy5T77AkIgiwj3VfoTD0-gzGzoHsz","app_key":"Q0n1AFSDoyYQsw7RI9eC1rfP","server_url":null,"security":true};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script></div></footer></div><script size="300" alpha="0.6" zindex="-1" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-ribbon@1/canvas-ribbon.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var o,n,e=document.getElementsByTagName("link");if(0<e.length)for(i=0;i<e.length;i++)"canonical"==e[i].rel.toLowerCase()&&e[i].href&&(o=e[i].href);n=o?o.split(":")[0]:window.location.protocol.split(":")[0],o||(o=window.location.href),function(){var e=o,i=document.referrer;if(!/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(e)){var t="https"===String(n).toLowerCase()?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";i?(t+="?r="+encodeURIComponent(document.referrer),e&&(t+="&l="+e)):e&&(t+="?l="+e),(new Image).src=t}}(window)}()</script><script src="/js/local-search.js"></script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'wdEmjy5T77AkIgiwj3VfoTD0-gzGzoHsz',
      appKey     : 'Q0n1AFSDoyYQsw7RI9eC1rfP',
      placeholder: "(。・∀・)ノ )",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-CN' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><script type="text/javascript" src="/js/clicklove.js"></script><script async>window.onload=function(){var e=document.createElement("script"),t=document.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.src="/sw-register.js?v="+Date.now(),t.parentNode.insertBefore(e,t)}</script></body></html>