<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png"><link rel="mask-icon" href="/images/logo.png" color="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=EB Garamond:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-mac-osx.min.css"><script src="/lib/pace/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"brookliu.xyz",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"always",padding:18,offset:12,onmobile:!0},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"./public/search.xml"}</script><meta name="description" content="前言在上一篇文章Express+MongoDB搭建图片分享社区一中我们实现了路由、页面和数据渲染。"><meta property="og:type" content="article"><meta property="og:title" content="Express+MongoDB搭建图片分享社区二"><meta property="og:url" content="https://brookliu.xyz/2020/10/14/Express-MongoDB%E6%90%AD%E5%BB%BA%E5%9B%BE%E7%89%87%E5%88%86%E4%BA%AB%E7%A4%BE%E5%8C%BA%E4%BA%8C/index.html"><meta property="og:site_name" content="1024肥宅"><meta property="og:description" content="前言在上一篇文章Express+MongoDB搭建图片分享社区一中我们实现了路由、页面和数据渲染。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://static.tuture.co/c/69b697ed0cd9f890a636c9c78eb2ce0c/figure-4.png"><meta property="og:image" content="https://img.brookliu.xyz/blog/express%2BmongoDB-2-1.png"><meta property="og:image" content="https://img.brookliu.xyz/blog/express%2BmongoDB-2-2.png"><meta property="og:image" content="https://img.brookliu.xyz/blog/express%2BmongoDB-2-3.png"><meta property="og:image" content="https://img.brookliu.xyz/blog/express%2BmongoDB-2-4.png"><meta property="og:image" content="https://img.brookliu.xyz/blog/express%2BmongoDB-2-5.png"><meta property="og:image" content="https://img.brookliu.xyz/blog/express%2BmongoDB-2-6.png"><meta property="article:published_time" content="2020-10-14T07:58:12.000Z"><meta property="article:modified_time" content="2020-10-14T08:15:40.000Z"><meta property="article:author" content="Brookliu"><meta property="article:tag" content="Node"><meta property="article:tag" content="Express"><meta property="article:tag" content="MongoDB"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://static.tuture.co/c/69b697ed0cd9f890a636c9c78eb2ce0c/figure-4.png"><link rel="canonical" href="https://brookliu.xyz/2020/10/14/Express-MongoDB%E6%90%AD%E5%BB%BA%E5%9B%BE%E7%89%87%E5%88%86%E4%BA%AB%E7%A4%BE%E5%8C%BA%E4%BA%8C/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>Express+MongoDB搭建图片分享社区二 | 1024肥宅</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="1024肥宅" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a href="https://github.com/liubrook" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">1024肥宅</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> 标签<span class="badge">22</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> 分类<span class="badge">18</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档<span class="badge">65</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div> <a href="https://github.com/liubrook" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://brookliu.xyz/2020/10/14/Express-MongoDB%E6%90%AD%E5%BB%BA%E5%9B%BE%E7%89%87%E5%88%86%E4%BA%AB%E7%A4%BE%E5%8C%BA%E4%BA%8C/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/logo.png"><meta itemprop="name" content="Brookliu"><meta itemprop="description" content="扶我起来，我还能写"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="1024肥宅"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Express+MongoDB搭建图片分享社区二</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-10-14 15:58:12 / 修改时间：16:15:40" itemprop="dateCreated datePublished" datetime="2020-10-14T15:58:12+08:00">2020-10-14</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node/" itemprop="url" rel="index"><span itemprop="name">Node</span></a></span></span><span id="/2020/10/14/Express-MongoDB%E6%90%AD%E5%BB%BA%E5%9B%BE%E7%89%87%E5%88%86%E4%BA%AB%E7%A4%BE%E5%8C%BA%E4%BA%8C/" class="post-meta-item leancloud_visitors" data-flag-title="Express+MongoDB搭建图片分享社区二" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span> <span>℃</span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/2020/10/14/Express-MongoDB%E6%90%AD%E5%BB%BA%E5%9B%BE%E7%89%87%E5%88%86%E4%BA%AB%E7%A4%BE%E5%8C%BA%E4%BA%8C/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2020/10/14/Express-MongoDB%E6%90%AD%E5%BB%BA%E5%9B%BE%E7%89%87%E5%88%86%E4%BA%AB%E7%A4%BE%E5%8C%BA%E4%BA%8C/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在上一篇文章<a href="https://brookliu.xyz/2020/10/13/Express-MongoDB%E6%90%AD%E5%BB%BA%E5%9B%BE%E7%89%87%E5%88%86%E4%BA%AB%E7%A4%BE%E5%8C%BA%E4%B8%80/#more">Express+MongoDB搭建图片分享社区一</a>中我们实现了路由、页面和数据渲染。</p><a id="more"></a><p>本篇文章我们要实现图片上传、接入mongoDB数据库、评论、点赞、删除等功能。</p><h3 id="图片上传功能"><a href="#图片上传功能" class="headerlink" title="图片上传功能"></a>图片上传功能</h3><p>在根目录创建public/upload文件夹，用于存放用户上传的图片, 然后安装 multer 中间件用于处理文件上传：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i multer</span><br></pre></td></tr></table></figure><p>在 server/routes.js 模块中，我们初始化 multer 中间件，然后将其添加到上传图片的路由中（即 POST /images）, 代码如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const express &#x3D; require(&#39;express&#39;);</span><br><span class="line">const multer &#x3D; require(&#39;multer&#39;);</span><br><span class="line">const path &#x3D; require(&#39;path&#39;);</span><br><span class="line"></span><br><span class="line">const router &#x3D; express.Router();</span><br><span class="line">const upload &#x3D; multer(&#123; dest: path.join(__dirname, &#39;..&#x2F;public&#x2F;upload&#x2F;temp&#39;) &#125;);</span><br><span class="line">const home &#x3D; require(&#39;..&#x2F;controllers&#x2F;home&#39;);</span><br><span class="line">const image &#x3D; require(&#39;..&#x2F;controllers&#x2F;image&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; function(app) &#123;</span><br><span class="line">  router.get(&#39;&#x2F;&#39;, home.index);</span><br><span class="line">  router.get(&#39;&#x2F;images&#x2F;:image_id&#39;, image.index);</span><br><span class="line">  router.post(&#39;&#x2F;images&#39;, upload.single(&#39;file&#39;), image.create);</span><br><span class="line">  router.post(&#39;&#x2F;images&#x2F;:image_id&#x2F;like&#39;, image.like);</span><br><span class="line">  router.post(&#39;&#x2F;images&#x2F;:image_id&#x2F;comment&#39;, image.comment);</span><br><span class="line">  app.use(router);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>上述代码有两点需要讲解：</p><ul><li>第 6 行，在初始化 upload 中间件时，传入 dest 选项指定保存上传文件的路径，这里我们选择在 public/upload 目录中再创建一个 temp 目录用于临时保存上传到的图片。</li><li>第 14 行，router.post 除第一个参数为 URL，后面可以跟任意多个中间件，这里我们将上传文件的中间件添加到 image.create 控制器的前面，确保先处理用户上传的文件。这里 upload.single(‘file’) 表示只处理单个上传文件，并且字段名为 file，在后续中间件中就可以通过 req.file 进行获取。</li></ul><div class="note info"><p>注意</p><p>在dest选项这里图灵社区的路径是public/upload/temp，但是我在操作过程中发现这个路径不是项目根目录下，而是在当前server文件夹下，所以这里的路径要用../public/upload/temp</p></div><p>关于 multer 的详细用法，可以参考其<a href="https://github.com/expressjs/multer" target="_blank" rel="noopener">文档</a></p><p>controller/image.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">const fs &#x3D; require(&#39;fs&#39;);</span><br><span class="line">const path &#x3D; require(&#39;path&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  index: function(req, res) &#123;</span><br><span class="line">    const viewModel &#x3D; &#123;</span><br><span class="line">      image: &#123;</span><br><span class="line">        uniqueId: 1,</span><br><span class="line">        title: &#39;示例图片1&#39;,</span><br><span class="line">        description: &#39;这是张测试图片&#39;,</span><br><span class="line">        filename: &#39;sample1.jpg&#39;,</span><br><span class="line">        views: 0,</span><br><span class="line">        likes: 0,</span><br><span class="line">        timestamp: Date.now(),</span><br><span class="line">      &#125;,</span><br><span class="line">      comments: [</span><br><span class="line">        &#123;</span><br><span class="line">          image_id: 1,</span><br><span class="line">          email: &#39;test@testing.com&#39;,</span><br><span class="line">          name: &#39;Test Tester&#39;,</span><br><span class="line">          comment: &#39;Test 1&#39;,</span><br><span class="line">          timestamp: Date.now(),</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          image_id: 1,</span><br><span class="line">          email: &#39;test@testing.com&#39;,</span><br><span class="line">          name: &#39;Test Tester&#39;,</span><br><span class="line">          comment: &#39;Test 2&#39;,</span><br><span class="line">          timestamp: Date.now(),</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;;</span><br><span class="line">    res.render(&#39;image&#39;, viewModel);</span><br><span class="line">  &#125;,</span><br><span class="line">  create: function(req, res) &#123;</span><br><span class="line">    var tempPath &#x3D; req.file.path;</span><br><span class="line">    var imgUrl &#x3D; req.file.filename;</span><br><span class="line">    var ext &#x3D; path.extname(req.file.originalname).toLowerCase();</span><br><span class="line">    var targetPath &#x3D; path.resolve(&#39;.&#x2F;public&#x2F;upload&#x2F;&#39; + imgUrl + ext);</span><br><span class="line"></span><br><span class="line">    if (ext &#x3D;&#x3D;&#x3D; &#39;.png&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.jpg&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.jpeg&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.gif&#39;) &#123;</span><br><span class="line">      fs.rename(tempPath, targetPath, function(err) &#123;</span><br><span class="line">        if (err) throw err;</span><br><span class="line">        res.redirect(&#39;&#x2F;images&#x2F;&#39; + imgUrl);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      fs.unlink(tempPath, function(err) &#123;</span><br><span class="line">        if (err) throw err;</span><br><span class="line">        res.json(500, &#123; error: &#39;只允许上传图片文件.&#39; &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  like: function(req, res) &#123;</span><br><span class="line">    res.send(&#39;The image:like POST controller&#39;);</span><br><span class="line">  &#125;,</span><br><span class="line">  comment: function(req, res) &#123;</span><br><span class="line">    res.send(&#39;The image:comment POST controller&#39;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>req.file 是一个 Multer 文件对象，包括 path（上传到服务器的路径）、filename（服务器存储的文件名）和 originalname（文件初始名，即保存在客户端的文件名）等有用的属性。我截取了一张输出 req.file 所有字段的图片如下：<br><img src="https://static.tuture.co/c/69b697ed0cd9f890a636c9c78eb2ce0c/figure-4.png" alt="req.file图"></p><p>这里我们通过简单的后缀匹配来判断用户上传的是否为图片，如果是，则从临时目录 tempPath 存放到上传目录 targetPath 中，否则直接删除。上传成功后，通过 res.redirect 将页面重定向到刚刚上传的图片的详情页面。</p><h3 id="接入MongoDB数据库"><a href="#接入MongoDB数据库" class="headerlink" title="接入MongoDB数据库"></a>接入MongoDB数据库</h3><p>首先安装MongoDB：</p><p><a href="https://www.mongodb.com/try/download/community" target="_blank" rel="noopener">MongoDB官网</a><br><a href="https://www.runoob.com/mongodb/mongodb-osx-install.html" target="_blank" rel="noopener">菜鸟教程MongoDB安装</a></p><p>安装之后新开一个终端根据不同平台的对应方法打开数据库。</p><p>然后安装Mongoose：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i mongoose</span><br></pre></td></tr></table></figure><p>Mongoose 是 MongoDB 最流行的 ODM（Object Document Mapping，对象文档映射），使用起来要比底层的 MongoDB Node 驱动更方便。</p><p>我们首先实现图片有关的数据模型。创建 models 目录，在其中添加 image.js 模块，并添加实现 ImageSchema 的代码：<br>model/image.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">const mongoose &#x3D; require(&#39;mongoose&#39;);</span><br><span class="line">const path &#x3D; require(&#39;path&#39;);</span><br><span class="line"></span><br><span class="line">const Schema &#x3D; mongoose.Schema;</span><br><span class="line"></span><br><span class="line">const ImageSchema &#x3D; new Schema(&#123;</span><br><span class="line">  title: &#123; type: String &#125;,</span><br><span class="line">  description: &#123; type: String &#125;,</span><br><span class="line">  filename: &#123; type: String &#125;,</span><br><span class="line">  views: &#123; type: Number, default: 0 &#125;,</span><br><span class="line">  likes: &#123; type: Number, default: 0 &#125;,</span><br><span class="line">  timestamp: &#123; type: Date, default: Date.now &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ImageSchema.virtual(&#39;uniqueId&#39;).get(function() &#123;</span><br><span class="line">  return this.filename.replace(path.extname(this.filename), &#39;&#39;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; mongoose.model(&#39;Image&#39;, ImageSchema);</span><br></pre></td></tr></table></figure><p>我们在第 6 行到第 13 行定义了一个 Schema，即数据对象的模式，描述了这个模型的所有字段及相应的属性。这里我们为 ImageSchema 定义了六个字段，每个字段都有其类型（必须），views、likes 和 timestamp 还有相应的默认值（可选）。除了普通字段外，我们还定义了虚字段uniqueId。虚字段（virtuals）和普通字段的最大区别是不会保存到数据库中，而是在每次查询时临时计算，通常用于对普通字段进行格式调整或组合。在 Schema 定义完成后，我们将其编译为名为 Image 的模型并导出，方便在控制器中进行使用。</p><p>接着我们在 home 控制器中调用 ImageModel 来从数据库中获取全部图片：<br>controller/home.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const ImageModel &#x3D; require(&#39;..&#x2F;models&#x2F;image&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  index: function(req, res) &#123;</span><br><span class="line">    const viewModel &#x3D; &#123; images: [] &#125;;</span><br><span class="line"></span><br><span class="line">    ImageModel.find(&#123;&#125;, &#123;&#125;, &#123; sort: &#123; timestamp: -1 &#125; &#125;, function(err, images) &#123;</span><br><span class="line">      if (err) throw err;</span><br><span class="line">      viewModel.images &#x3D; images;</span><br><span class="line">      res.render(&#39;index&#39;, viewModel);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>在第 39 行中，我们用 find 方法查询图片，所有的查询方法可参考 <a href="http://www.mongoosejs.net/" target="_blank" rel="noopener">Mongoose 中文文档</a>。find 是查询多条数据记录的通用方法，其四个参数如下：</p><ul><li>filter：过滤器，是一个 JavaScript 对象，例如 { name: ‘john’ } 则限定返回所有名字为 john 的记录，这里我们用 {} 表示查询所有记录；</li><li>projection（可选）：查询所返回的字段，可以是对象或字符串，我们用 {} 表示返回所有字段；</li><li>options（可选）：查询操作的选项，用来指定查询操作的一些参数，比如我们用 sort 选项对返回结果进行排序（这里按照发布时间 timestamp 进行倒序排列，即把最新发布的放在最前面）；</li><li>callback：回调函数，用于添加在查询完毕时的业务逻辑；</li></ul><p>进一步，我们在 image 控制器中添加数据库操作的代码：<br>controller/image.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">const fs &#x3D; require(&#39;fs&#39;);</span><br><span class="line">const path &#x3D; require(&#39;path&#39;);</span><br><span class="line">const ImageModel &#x3D; require(&#39;..&#x2F;models&#x2F;image&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  index: function(req, res) &#123;</span><br><span class="line">    const viewModel &#x3D; &#123; image: &#123;&#125;, comments: [] &#125;;</span><br><span class="line"></span><br><span class="line">    ImageModel.findOne(&#123; filename: &#123; $regex: req.params.image_id &#125; &#125;, function(</span><br><span class="line">      err,</span><br><span class="line">      image,</span><br><span class="line">    ) &#123;</span><br><span class="line">      if (err) throw err;</span><br><span class="line">      if (image) &#123;</span><br><span class="line">        &#x2F;&#x2F; 增加该图片的访问量</span><br><span class="line">        image.views +&#x3D; 1;</span><br><span class="line">        viewModel.image &#x3D; image;</span><br><span class="line">        image.save();</span><br><span class="line">        res.render(&#39;image&#39;, viewModel);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        res.redirect(&#39;&#x2F;&#39;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  create: function(req, res) &#123;</span><br><span class="line">    var tempPath &#x3D; req.file.path;</span><br><span class="line">    var imgUrl &#x3D; req.file.filename;</span><br><span class="line">    var ext &#x3D; path.extname(req.file.originalname).toLowerCase();</span><br><span class="line">    var targetPath &#x3D; path.resolve(&#39;.&#x2F;public&#x2F;upload&#x2F;&#39; + imgUrl + ext);</span><br><span class="line"></span><br><span class="line">    if (ext &#x3D;&#x3D;&#x3D; &#39;.png&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.jpg&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.jpeg&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.gif&#39;) &#123;</span><br><span class="line">      fs.rename(tempPath, targetPath, function(err) &#123;</span><br><span class="line">        if (err) throw err;</span><br><span class="line">        const newImg &#x3D; new ImageModel(&#123;</span><br><span class="line">          title: req.body.title,</span><br><span class="line">          description: req.body.description,</span><br><span class="line">          filename: imgUrl + ext,</span><br><span class="line">        &#125;);</span><br><span class="line">        newImg.save(function(err, image) &#123;</span><br><span class="line">          if (err) throw err;</span><br><span class="line">          res.redirect(&#39;&#x2F;images&#x2F;&#39; + image.uniqueId);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      fs.unlink(tempPath, function(err) &#123;</span><br><span class="line">        if (err) throw err;</span><br><span class="line">        res.json(500, &#123; error: &#39;只允许上传图片文件.&#39; &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  like: function(req, res) &#123;</span><br><span class="line">    res.send(&#39;The image:like POST controller&#39;);</span><br><span class="line">  &#125;,</span><br><span class="line">  comment: function(req, res) &#123;</span><br><span class="line">    res.send(&#39;The image:comment POST controller&#39;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>在 image.index 和 image.create 两个控制器中，我们分别进行了单条数据记录的查询和插入。findOne 与之前的 find 参数格式完全一致，只不过仅返回一条数据。在插入新数据时，先创建一个 ImageModel 实例，然后再调用 save 方法进行保存即可。</p><p>最后，我们需要在服务器刚刚运行时就连接好数据库，因此在 server.js 中添加如下代码：<br>server.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">const express &#x3D; require(&#39;express&#39;);</span><br><span class="line">const mongoose &#x3D; require(&#39;mongoose&#39;);</span><br><span class="line">const configure &#x3D; require(&#39;.&#x2F;server&#x2F;configure&#39;);</span><br><span class="line"></span><br><span class="line">app &#x3D; express();</span><br><span class="line">app &#x3D; configure(app);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 建立数据库连接</span><br><span class="line">mongoose.connect(&#39;mongodb:&#x2F;&#x2F;localhost&#x2F;instagrammy&#39;);</span><br><span class="line">mongoose.connection.on(&#39;open&#39;, function() &#123;</span><br><span class="line">  console.log(&#39;Mongoose connected.&#39;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.set(&#39;port&#39;, process.env.PORT || 3000);</span><br><span class="line"></span><br><span class="line">app.listen(app.get(&#39;port&#39;), function() &#123;</span><br><span class="line">  console.log(&#96;Server is running on http:&#x2F;&#x2F;localhost:$&#123;app.get(&#39;port&#39;)&#125;&#96;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="运行过程中的问题"><a href="#运行过程中的问题" class="headerlink" title="运行过程中的问题"></a>运行过程中的问题</h3><p>这里我们运行服务器的话会有如下的输出信息:<br><img src="https://img.brookliu.xyz/blog/express%2BmongoDB-2-1.png" alt="输出1"></p><p>解决方法:<br>mongoose连接数据库时除了url参数外增加1个参数： {useNewUrlParser:true,useUnifiedTopology: true}<br>server.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const express &#x3D; require(&#39;express&#39;);</span><br><span class="line">const mongoose &#x3D; require(&#39;mongoose&#39;);</span><br><span class="line">const configure &#x3D; require(&#39;.&#x2F;server&#x2F;configure&#39;);</span><br><span class="line"></span><br><span class="line">app &#x3D; express();</span><br><span class="line">app &#x3D; configure(app);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 建立数据库连接</span><br><span class="line">mongoose.connect(&#39;mongodb:&#x2F;&#x2F;localhost&#x2F;instagrammy&#39;, &#123;useNewUrlParser:true,useUnifiedTopology:true &#125;);</span><br><span class="line">mongoose.connection.on(&#39;open&#39;, function() &#123;</span><br><span class="line">    console.log(&#39;Mongoose connected.&#39;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.set(&#39;port&#39;, process.env.PORT || 3000);</span><br><span class="line"></span><br><span class="line">app.listen(app.get(&#39;port&#39;), function() &#123;</span><br><span class="line">    console.log(&#96;Server is running on http:&#x2F;&#x2F;localhost:$&#123;app.get(&#39;port&#39;)&#125;&#96;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>然后我们重新运行服务器，打开<a href="http://localhost:3000" target="_blank" rel="noopener">localhost:3000</a>，我们会发现console有报错信息：<br><img src="https://img.brookliu.xyz/blog/express%2BmongoDB-2-2.png" alt="输出2"></p><p>我们走一下上传图片的过程，上传跳转到图片详情会发现页面是这个样子:<br><img src="https://img.brookliu.xyz/blog/express%2BmongoDB-2-3.png" alt="输出3"></p><p>在服务器的日志上发现有如下所示信息：<br><img src="https://img.brookliu.xyz/blog/express%2BmongoDB-2-4.png" alt="输出4"></p><p>在<a href="https://stackoverflow.com/questions/59690923/handlebars-access-has-been-denied-to-resolve-the-property-from-because-it-is" target="_blank" rel="noopener">stackoverflow</a>有这个问题的<br>相关讨论，有兴趣的可以去看一下</p><p>解决方法：</p><p>安装依赖：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @handlebars&#x2F;allow-prototype-access</span><br></pre></td></tr></table></figure><p>然后修改server/configure.js的内容如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">const path &#x3D; require(&#39;path&#39;);</span><br><span class="line">const Handlebars &#x3D; require(&#39;handlebars&#39;);</span><br><span class="line">const exphbs &#x3D; require(&#39;express-handlebars&#39;);</span><br><span class="line">const express &#x3D; require(&#39;express&#39;);</span><br><span class="line">const bodyParser &#x3D; require(&#39;body-parser&#39;);</span><br><span class="line">const cookieParser &#x3D; require(&#39;cookie-parser&#39;);</span><br><span class="line">const morgan &#x3D; require(&#39;morgan&#39;);</span><br><span class="line">const methodOverride &#x3D; require(&#39;method-override&#39;);</span><br><span class="line">const errorHandler &#x3D; require(&#39;errorhandler&#39;);</span><br><span class="line">const moment &#x3D; require(&#39;moment&#39;);</span><br><span class="line"></span><br><span class="line">const &#123; allowInsecurePrototypeAccess &#125; &#x3D; require(&#39;@handlebars&#x2F;allow-prototype-access&#39;);</span><br><span class="line"></span><br><span class="line">const routes &#x3D; require(&#39;.&#x2F;routes&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; function(app) &#123;</span><br><span class="line">    &#x2F;&#x2F; 定义 moment 全局语言 </span><br><span class="line">    moment.locale(&#39;zh-cn&#39;);</span><br><span class="line">    app.engine(&#39;handlebars&#39;, exphbs.create(&#123;</span><br><span class="line">        helpers: &#123;</span><br><span class="line">            timeago: function(timestamp) &#123;</span><br><span class="line">                return moment(timestamp).startOf(&#39;minute&#39;).fromNow();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        handlebars: allowInsecurePrototypeAccess(Handlebars)</span><br><span class="line">    &#125;).engine)</span><br><span class="line">    app.set(&#39;view engine&#39;, &#39;handlebars&#39;);</span><br><span class="line"></span><br><span class="line">    app.use(morgan(&#39;dev&#39;));</span><br><span class="line">    app.use(bodyParser.urlencoded(&#123; extended: true &#125;));</span><br><span class="line">    app.use(bodyParser.json());</span><br><span class="line">    app.use(methodOverride());</span><br><span class="line">    app.use(cookieParser(&#39;secret-value&#39;));</span><br><span class="line">    app.use(&#39;&#x2F;public&#x2F;&#39;, express.static(path.join(__dirname, &#39;..&#x2F;public&#39;)));</span><br><span class="line"></span><br><span class="line">    if (app.get(&#39;env&#39;) &#x3D;&#x3D;&#x3D; &#39;development&#39;) &#123;</span><br><span class="line">        app.use(errorHandler())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    routes(app);</span><br><span class="line">    return app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在我们来重新运行服务器，尝试上传图片，可以发现不仅能上传成功，还可以在首页看到新添加的图片了！</p><h3 id="实现评论功能"><a href="#实现评论功能" class="headerlink" title="实现评论功能"></a>实现评论功能</h3><p>这一步我们来实现网站的评论功能。按照 MVC 模式，我们将依次实现评论的模型（M）、视图（V）和控制器（C）。<br>首先，仿照 models/image.js，我们实现评论的数据模型：<br>models/comment.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">const mongoose &#x3D; require(&#39;mongoose&#39;);</span><br><span class="line"></span><br><span class="line">const Schema &#x3D; mongoose.Schema;</span><br><span class="line">const ObjectId &#x3D; Schema.ObjectId;</span><br><span class="line"></span><br><span class="line">const CommentSchema &#x3D; new Schema(&#123;</span><br><span class="line">  image_id: &#123; type: ObjectId &#125;,</span><br><span class="line">  email: &#123; type: String &#125;,</span><br><span class="line">  name: &#123; type: String &#125;,</span><br><span class="line">  gravatar: &#123; type: String &#125;,</span><br><span class="line">  comment: &#123; type: String &#125;,</span><br><span class="line">  timestamp: &#123; type: Date, default: Date.now &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">CommentSchema.virtual(&#39;image&#39;)</span><br><span class="line">  .set(function(image) &#123;</span><br><span class="line">    this._image &#x3D; image;</span><br><span class="line">  &#125;)</span><br><span class="line">  .get(function() &#123;</span><br><span class="line">    return this._image;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; mongoose.model(&#39;Comment&#39;, CommentSchema);</span><br></pre></td></tr></table></figure><p>CommentSchema 有两个字段需要补充说明一下：</p><ul><li>image_id：由于图片和评论是一对多的关系（即一张图片包括多个评论），因此我们需要在记录每个评论所属的图片，即通过 image_id 字段进行记录；</li><li>gravatar：用 MD5 对电子邮箱加密后得到的字符串，用于访问 <a href="https://en.gravatar.com/" target="_blank" rel="noopener">Gravatar 服务</a>。Gravatar 提供了跨网站的头像服务，如果你在集成了 Gravatar 服务的网站通过邮箱注册并上传了头像，那么别的网站也可以通过 Gravatar 访问你的头像。这里请通过 npm install md5 安装 MD5 加密的包。</li></ul><p>我们对评论有关的界面代码进行细微的调整，将提交按钮的 type 从 button 改为 submit：<br>views/image.handlebars<br><img src="https://img.brookliu.xyz/blog/express%2BmongoDB-2-5.png" alt="评论"></p><p>最后是评论有关的 controller 代码。包括在 image.comment 中实现创建评论，以及在 image.index 中实现对单张图片所有评论的查询：<br>controllers/image.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">const fs &#x3D; require(&#39;fs&#39;);</span><br><span class="line">const path &#x3D; require(&#39;path&#39;);</span><br><span class="line">const md5 &#x3D; require(&#39;md5&#39;);</span><br><span class="line">const ImageModel &#x3D; require(&#39;..&#x2F;models&#x2F;image&#39;);</span><br><span class="line">const CommentModel &#x3D; require(&#39;..&#x2F;models&#x2F;comment&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  index: function(req, res) &#123;</span><br><span class="line">    const viewModel &#x3D; &#123; image: &#123;&#125;, comments: [] &#125;;</span><br><span class="line"></span><br><span class="line">    ImageModel.findOne(&#123; filename: &#123; $regex: req.params.image_id &#125; &#125;, function(</span><br><span class="line">      err,</span><br><span class="line">      image,</span><br><span class="line">    ) &#123;</span><br><span class="line">      if (err) throw err;</span><br><span class="line">      if (image) &#123;</span><br><span class="line">        &#x2F;&#x2F; 增加该图片的访问量</span><br><span class="line">        image.views +&#x3D; 1;</span><br><span class="line">        viewModel.image &#x3D; image;</span><br><span class="line">        image.save();</span><br><span class="line"></span><br><span class="line">        CommentModel.find(</span><br><span class="line">          &#123; image_id: image._id &#125;,</span><br><span class="line">          &#123;&#125;,</span><br><span class="line">          &#123; sort: &#123; timestamp: 1 &#125; &#125;,</span><br><span class="line">          function(err, comments) &#123;</span><br><span class="line">            if (err) throw err;</span><br><span class="line">            viewModel.comments &#x3D; comments;</span><br><span class="line">            res.render(&#39;image&#39;, viewModel);</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        res.redirect(&#39;&#x2F;&#39;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  create: function(req, res) &#123;</span><br><span class="line">    var tempPath &#x3D; req.file.path;</span><br><span class="line">    var imgUrl &#x3D; req.file.filename;</span><br><span class="line">    var ext &#x3D; path.extname(req.file.originalname).toLowerCase();</span><br><span class="line">    var targetPath &#x3D; path.resolve(&#39;.&#x2F;public&#x2F;upload&#x2F;&#39; + imgUrl + ext);</span><br><span class="line"></span><br><span class="line">    if (ext &#x3D;&#x3D;&#x3D; &#39;.png&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.jpg&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.jpeg&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.gif&#39;) &#123;</span><br><span class="line">      fs.rename(tempPath, targetPath, function(err) &#123;</span><br><span class="line">        if (err) throw err;</span><br><span class="line">        const newImg &#x3D; new ImageModel(&#123;</span><br><span class="line">          title: req.body.title,</span><br><span class="line">          description: req.body.description,</span><br><span class="line">          filename: imgUrl + ext,</span><br><span class="line">        &#125;);</span><br><span class="line">        newImg.save(function(err, image) &#123;</span><br><span class="line">          if (err) throw err;</span><br><span class="line">          res.redirect(&#39;&#x2F;images&#x2F;&#39; + image.uniqueId);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      fs.unlink(tempPath, function(err) &#123;</span><br><span class="line">        if (err) throw err;</span><br><span class="line">        res.json(500, &#123; error: &#39;只允许上传图片文件.&#39; &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  like: function(req, res) &#123;</span><br><span class="line">    res.send(&#39;The image:like POST controller&#39;);</span><br><span class="line">  &#125;,</span><br><span class="line">  comment: function(req, res) &#123;</span><br><span class="line">    ImageModel.findOne(&#123; filename: &#123; $regex: req.params.image_id &#125; &#125;, function(</span><br><span class="line">      err,</span><br><span class="line">      image,</span><br><span class="line">    ) &#123;</span><br><span class="line">      if (!err &amp;&amp; image) &#123;</span><br><span class="line">        const newComment &#x3D; new CommentModel(req.body);</span><br><span class="line">        newComment.gravatar &#x3D; md5(newComment.email);</span><br><span class="line">        newComment.image_id &#x3D; image._id;</span><br><span class="line">        newComment.save(function(err, comment) &#123;</span><br><span class="line">          if (err) throw err;</span><br><span class="line">          res.redirect(&#39;&#x2F;images&#x2F;&#39; + image.uniqueId + &#39;#&#39; + comment._id);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        res.redirect(&#39;&#x2F;&#39;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>查询与创建评论的代码和之前操作图片的代码大部分都是一致的，最大的差别在于查询时需要根据所属的图片 ID，创建时需要记录图片的 ID。这里我们约定使用 MongoDB 为每一条数据默认创建的 _id 字段。</p><p>接下来我们重启服务器，然后找一张图片点进详情测试一下评论功能<br><img src="https://img.brookliu.xyz/blog/express%2BmongoDB-2-6.png" alt="评论"></p><h3 id="实现图片的点赞和删除"><a href="#实现图片的点赞和删除" class="headerlink" title="实现图片的点赞和删除"></a>实现图片的点赞和删除</h3><p>这一步我们来实现图片的点赞和删除。<br>首先在控制器中添加点赞和删除的代码:<br>controller/image.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">const fs &#x3D; require(&#39;fs&#39;);</span><br><span class="line">const path &#x3D; require(&#39;path&#39;);</span><br><span class="line">const md5 &#x3D; require(&#39;md5&#39;);</span><br><span class="line">const ImageModel &#x3D; require(&#39;..&#x2F;models&#x2F;image&#39;);</span><br><span class="line">const CommentModel &#x3D; require(&#39;..&#x2F;models&#x2F;comment&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  index: function(req, res) &#123;</span><br><span class="line">    const viewModel &#x3D; &#123; image: &#123;&#125;, comments: [] &#125;;</span><br><span class="line"></span><br><span class="line">    ImageModel.findOne(&#123; filename: &#123; $regex: req.params.image_id &#125; &#125;, function(</span><br><span class="line">      err,</span><br><span class="line">      image,</span><br><span class="line">    ) &#123;</span><br><span class="line">      if (err) throw err;</span><br><span class="line">      if (image) &#123;</span><br><span class="line">        &#x2F;&#x2F; 增加该图片的访问量</span><br><span class="line">        image.views +&#x3D; 1;</span><br><span class="line">        viewModel.image &#x3D; image;</span><br><span class="line">        image.save();</span><br><span class="line"></span><br><span class="line">        CommentModel.find(</span><br><span class="line">          &#123; image_id: image._id &#125;,</span><br><span class="line">          &#123;&#125;,</span><br><span class="line">          &#123; sort: &#123; timestamp: 1 &#125; &#125;,</span><br><span class="line">          function(err, comments) &#123;</span><br><span class="line">            if (err) throw err;</span><br><span class="line">            viewModel.comments &#x3D; comments;</span><br><span class="line">            res.render(&#39;image&#39;, viewModel);</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        res.redirect(&#39;&#x2F;&#39;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  create: function(req, res) &#123;</span><br><span class="line">    var tempPath &#x3D; req.file.path;</span><br><span class="line">    var imgUrl &#x3D; req.file.filename;</span><br><span class="line">    var ext &#x3D; path.extname(req.file.originalname).toLowerCase();</span><br><span class="line">    var targetPath &#x3D; path.resolve(&#39;.&#x2F;public&#x2F;upload&#x2F;&#39; + imgUrl + ext);</span><br><span class="line"></span><br><span class="line">    if (ext &#x3D;&#x3D;&#x3D; &#39;.png&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.jpg&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.jpeg&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.gif&#39;) &#123;</span><br><span class="line">      fs.rename(tempPath, targetPath, function(err) &#123;</span><br><span class="line">        if (err) throw err;</span><br><span class="line">        const newImg &#x3D; new ImageModel(&#123;</span><br><span class="line">          title: req.body.title,</span><br><span class="line">          description: req.body.description,</span><br><span class="line">          filename: imgUrl + ext,</span><br><span class="line">        &#125;);</span><br><span class="line">        newImg.save(function(err, image) &#123;</span><br><span class="line">          if (err) throw err;</span><br><span class="line">          res.redirect(&#39;&#x2F;images&#x2F;&#39; + image.uniqueId);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      fs.unlink(tempPath, function(err) &#123;</span><br><span class="line">        if (err) throw err;</span><br><span class="line">        res.json(500, &#123; error: &#39;只允许上传图片文件.&#39; &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  like: function(req, res) &#123;</span><br><span class="line">    ImageModel.findOne(&#123; filename: &#123; $regex: req.params.image_id &#125; &#125;, function(</span><br><span class="line">      err,</span><br><span class="line">      image,</span><br><span class="line">    ) &#123;</span><br><span class="line">      if (!err &amp;&amp; image) &#123;</span><br><span class="line">        image.likes +&#x3D; 1;</span><br><span class="line">        image.save(function(err) &#123;</span><br><span class="line">          if (err) res.json(err);</span><br><span class="line">          else res.json(&#123; likes: image.likes &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  remove: function(req, res) &#123;</span><br><span class="line">    ImageModel.findOne(&#123; filename: &#123; $regex: req.params.image_id &#125; &#125;, function(</span><br><span class="line">      err,</span><br><span class="line">      image,</span><br><span class="line">    ) &#123;</span><br><span class="line">      if (err) throw err;</span><br><span class="line">      fs.unlink(path.resolve(&#39;.&#x2F;public&#x2F;upload&#x2F;&#39; + image.filename), function(</span><br><span class="line">        err,</span><br><span class="line">      ) &#123;</span><br><span class="line">        if (err) throw err;</span><br><span class="line">        CommentModel.remove(&#123; image_id: image._id &#125;, function(err) &#123;</span><br><span class="line">          image.remove(function(err) &#123;</span><br><span class="line">            if (!err) &#123;</span><br><span class="line">              res.json(true);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              res.json(false);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  comment: function(req, res) &#123;</span><br><span class="line">    ImageModel.findOne(&#123; filename: &#123; $regex: req.params.image_id &#125; &#125;, function(</span><br><span class="line">      err,</span><br><span class="line">      image,</span><br><span class="line">    ) &#123;</span><br><span class="line">      if (!err &amp;&amp; image) &#123;</span><br><span class="line">        const newComment &#x3D; new CommentModel(req.body);</span><br><span class="line">        newComment.gravatar &#x3D; md5(newComment.email);</span><br><span class="line">        newComment.image_id &#x3D; image._id;</span><br><span class="line">        newComment.save(function(err, comment) &#123;</span><br><span class="line">          if (err) throw err;</span><br><span class="line">          res.redirect(&#39;&#x2F;images&#x2F;&#39; + image.uniqueId + &#39;#&#39; + comment._id);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        res.redirect(&#39;&#x2F;&#39;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>在两个控制器中，我们都按照查询 -&gt; 修改 -&gt; 保存的流程进行操作。不过在删除图片中，我们不仅先删除上传图片，再删除了此图片所有的评论模型，最后再删除数据库中的图片模型，这一切通过 Model.remove 方法都可以轻松实现。remove 的使用方法与之前的 find 几乎一模一样，只不过 find 会返回符合条件的结果，而 remove 则会直接将符合条件的记录从数据库中删除。</p><p>我们在路由模块 server/routes.js 中添加刚刚写好的 image.remove 控制器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const express &#x3D; require(&#39;express&#39;);</span><br><span class="line">const multer &#x3D; require(&#39;multer&#39;);</span><br><span class="line">const path &#x3D; require(&#39;path&#39;);</span><br><span class="line"></span><br><span class="line">const router &#x3D; express.Router();</span><br><span class="line">const upload &#x3D; multer(&#123; dest: path.join(__dirname, &#39;public&#x2F;upload&#x2F;temp&#39;) &#125;);</span><br><span class="line">const home &#x3D; require(&#39;..&#x2F;controllers&#x2F;home&#39;);</span><br><span class="line">const image &#x3D; require(&#39;..&#x2F;controllers&#x2F;image&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; function(app) &#123;</span><br><span class="line">  router.get(&#39;&#x2F;&#39;, home.index);</span><br><span class="line">  router.get(&#39;&#x2F;images&#x2F;:image_id&#39;, image.index);</span><br><span class="line">  router.post(&#39;&#x2F;images&#39;, upload.single(&#39;file&#39;), image.create);</span><br><span class="line">  router.post(&#39;&#x2F;images&#x2F;:image_id&#x2F;like&#39;, image.like);</span><br><span class="line">  router.post(&#39;&#x2F;images&#x2F;:image_id&#x2F;comment&#39;, image.comment);</span><br><span class="line">  router.delete(&#39;&#x2F;images&#x2F;:image_id&#39;, image.remove);</span><br><span class="line">  app.use(router);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>我们来重新运行服务器，然后试一下点赞和删除发现并没有任何作用，因为上面的只是服务端的逻辑，前端页面显示并没有对应的逻辑，所以我们用jQuery来实现前端的点赞和删除请求。<br>views/layouts/main.handlebars</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">  &lt;title&gt;Instagrammy&lt;&#x2F;title&gt;</span><br><span class="line">  &lt;link href&#x3D;&quot;http:&#x2F;&#x2F;netdna.bootstrapcdn.com&#x2F;bootstrap&#x2F;3.1.1&#x2F;css&#x2F;bootstrap.min.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">  &lt;link href&#x3D;&quot;http:&#x2F;&#x2F;netdna.bootstrapcdn.com&#x2F;font-awesome&#x2F;4.0.3&#x2F;css&#x2F;font-awesome.min.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div class&#x3D;&quot;page-header&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">      &lt;div class&#x3D;&quot;col-md-6&quot;&gt;</span><br><span class="line">        &lt;h1&gt;&lt;a href&#x3D;&quot;&#x2F;&quot;&gt;Instagrammy&lt;&#x2F;a&gt;&lt;&#x2F;h1&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">      &lt;div class&#x3D;&quot;col-sm-8&quot;&gt;&#123;&#123;&#123;body&#125;&#125;&#125;&lt;&#x2F;div&gt;</span><br><span class="line">      &lt;div class&#x3D;&quot;col-sm-4&quot;&gt;</span><br><span class="line">        &#123;&#123;&gt; stats this&#125;&#125;</span><br><span class="line">        &#123;&#123;&gt; popular this&#125;&#125;</span><br><span class="line">        &#123;&#123;&gt; comments this&#125;&#125;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;jquery&#x2F;3.4.1&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  $(function () &#123;</span><br><span class="line">    &#x2F;&#x2F; to do...</span><br><span class="line">  &#125;);</span><br><span class="line">  $(&#39;#btn-like&#39;).on(&#39;click&#39;, function (event) &#123;</span><br><span class="line">    event.preventDefault();</span><br><span class="line">    var imgId &#x3D; $(this).data(&#39;id&#39;);</span><br><span class="line">    $.post(&#39;&#x2F;images&#x2F;&#39; + imgId + &#39;&#x2F;like&#39;).done(function (data) &#123;</span><br><span class="line">      $(&#39;.likes-count&#39;).text(data.likes);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  $(&#39;#btn-delete&#39;).on(&#39;click&#39;, function (event) &#123;</span><br><span class="line">    event.preventDefault();</span><br><span class="line">    var $this &#x3D; $(this);</span><br><span class="line">    var remove &#x3D; confirm(&#39;确定要删除这张图片吗?&#39;);</span><br><span class="line">    if (remove) &#123;</span><br><span class="line">      var imgId &#x3D; $(this).data(&#39;id&#39;);</span><br><span class="line">      $</span><br><span class="line">        .ajax(&#123;</span><br><span class="line">          url: &#39;&#x2F;images&#x2F;&#39; + imgId,</span><br><span class="line">          type: &#39;DELETE&#39;</span><br><span class="line">        &#125;)</span><br><span class="line">        .done(function (result) &#123;</span><br><span class="line">          if (result) &#123;</span><br><span class="line">            $this.removeClass(&#39;btn-danger&#39;).addClass(&#39;btn-success&#39;);</span><br><span class="line">            $this.find(&#39;i&#39;).removeClass(&#39;fa-times&#39;).addClass(&#39;fa-check&#39;);</span><br><span class="line">            $this.append(&#39;&lt;span&gt; 已删除!&lt;&#x2F;span&gt;&#39;);</span><br><span class="line">            alert(&#39;删除成功&#39;);</span><br><span class="line">            window.location.href&#x3D;document.referrer;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><p>现在我们重新运行服务器，然后打开<a href="http://localhost:3000" target="_blank" rel="noopener">localhost:3000</a>来体验下点赞和删除功能，可以看到点赞和删除已经实现了，下一步我们将完善侧边栏的数据同步更新。</p><h3 id="完善用户界面"><a href="#完善用户界面" class="headerlink" title="完善用户界面"></a>完善用户界面</h3><p>这一步我们将实现侧边栏所有数据的同步更新。<br>首先先创建helpers目录用于存放侧边栏数据获取的相关代码。然后分析一下数据同步逻辑（例如统计数据），我们发现要进行的查询非常多：图片总数、评论总数、图片所有的访问量、图片所有的点赞数。如果按照普通的写法，我们也许会这样写：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">queryA(function(err, resultsA) &#123;</span><br><span class="line">  queryB(function(err, resultsB) &#123;</span><br><span class="line">    queryC(function(err, resultsC) &#123;</span><br><span class="line">      queryD(function(err, resultsD) &#123;</span><br><span class="line">        &#x2F;&#x2F; some code ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样的代码不仅十分丑陋，难以维护（即大家常说的 “回调地狱”），而且性能也十分糟糕 —— 所有查询都是链式执行。但其实所有的查询都是相互独立的，完全可以并发进行，那我们应该怎么写呢？</p><p>答案就是 <a href="http://caolan.github.io/async/v3/" target="_blank" rel="noopener">async</a> 库。async 是在 ECMAScript 6 的 Promise 体系出现之前最流行的异步组件库，凭借其强大的性能、丰富且设计良好的接口成为 Node 和前端开发中解决异步的最佳选择之一。这里我们也用 async 来解决并发获取数据的问题。安装 async 包：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i async</span><br></pre></td></tr></table></figure><p>然后创建helpers/stats.js用户获取网站统计数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">const async &#x3D; require(&#39;async&#39;);</span><br><span class="line">const ImageModel &#x3D; require(&#39;..&#x2F;models&#x2F;image&#39;);</span><br><span class="line">const CommentModel &#x3D; require(&#39;..&#x2F;models&#x2F;comment&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; function(callback) &#123;</span><br><span class="line">  async.parallel(</span><br><span class="line">    [</span><br><span class="line">      function(next) &#123;</span><br><span class="line">        &#x2F;&#x2F; 统计图片总数</span><br><span class="line">        ImageModel.countDocuments(&#123;&#125;, next);</span><br><span class="line">      &#125;,</span><br><span class="line">      function(next) &#123;</span><br><span class="line">        &#x2F;&#x2F; 统计评论总数</span><br><span class="line">        CommentModel.countDocuments(&#123;&#125;, next);</span><br><span class="line">      &#125;,</span><br><span class="line">      function(next) &#123;</span><br><span class="line">        &#x2F;&#x2F; 对图片所有访问量求和</span><br><span class="line">        ImageModel.aggregate(</span><br><span class="line">          [</span><br><span class="line">            &#123;</span><br><span class="line">              $group: &#123;</span><br><span class="line">                _id: &#39;1&#39;,</span><br><span class="line">                viewsTotal: &#123; $sum: &#39;$views&#39; &#125;,</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">          ],</span><br><span class="line">          function(err, result) &#123;</span><br><span class="line">            if (err) &#123;</span><br><span class="line">              return next(err);</span><br><span class="line">            &#125;</span><br><span class="line">            var viewsTotal &#x3D; 0;</span><br><span class="line">            if (result.length &gt; 0) &#123;</span><br><span class="line">              viewsTotal +&#x3D; result[0].viewsTotal;</span><br><span class="line">            &#125;</span><br><span class="line">            next(null, viewsTotal);</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">      function(next) &#123;</span><br><span class="line">        &#x2F;&#x2F; 对所有点赞数求和</span><br><span class="line">        ImageModel.aggregate(</span><br><span class="line">          [</span><br><span class="line">            &#123;</span><br><span class="line">              $group: &#123;</span><br><span class="line">                _id: &#39;1&#39;,</span><br><span class="line">                likesTotal: &#123; $sum: &#39;$likes&#39; &#125;,</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">          ],</span><br><span class="line">          function(err, result) &#123;</span><br><span class="line">            if (err) &#123;</span><br><span class="line">              return next(err);</span><br><span class="line">            &#125;</span><br><span class="line">            var likesTotal &#x3D; 0;</span><br><span class="line">            if (result.length &gt; 0) &#123;</span><br><span class="line">              likesTotal +&#x3D; result[0].likesTotal;</span><br><span class="line">            &#125;</span><br><span class="line">            next(null, likesTotal);</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    function(err, results) &#123;</span><br><span class="line">      callback(null, &#123;</span><br><span class="line">        images: results[0],</span><br><span class="line">        comments: results[1],</span><br><span class="line">        views: results[2],</span><br><span class="line">        likes: results[3],</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这里我们用到了 async.parallel 接口，它接受两个参数：</p><ul><li>tasks：一个函数数组，每个函数对应一个异步任务（所有任务将并发执行），并且接受一个回调函数用于返回任务执行的结果；</li><li>callback：整个任务组的回调函数，可以获取所有异步任务执行完成后的所有结果。</li></ul><p>我们将四个数据查询任务包装成四个函数作为 async.parallel 的第一个参数，在最后的 callback 中返回所有查询结果。非常简洁、优雅。</p><p>接下来实现侧边栏中的最新图片模块，一个简单的数据库查询即可：<br>helpers/images.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const ImageModel &#x3D; require(&#39;..&#x2F;models&#x2F;image&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    popular: function(callback) &#123;</span><br><span class="line">        ImageModel.find(&#123;&#125;, &#123;&#125;, &#123; limit: 9, sort: &#123; likes: 01 &#125; &#125;, function(err, images) &#123;</span><br><span class="line">            if (err) return callback(err);</span><br><span class="line">            callback(null, images);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后是创建获取最新评论的代码。不过简单地查询评论模型是不够的，我们还需要获取到每个评论对应的图片，这时候用 async.each 函数对一个数组中所有对象进行异步操作最为合适不过。整个模块的代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">const async &#x3D; require(&#39;async&#39;);</span><br><span class="line">const ImageModel &#x3D; require(&#39;..&#x2F;models&#x2F;image&#39;);</span><br><span class="line">const CommentModel &#x3D; require(&#39;..&#x2F;models&#x2F;comment&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    newest: function(callback) &#123;</span><br><span class="line">        CommentModel.find(&#123;&#125;, &#123;&#125;, &#123; limit: 5, sort: &#123; timestamp: -1 &#125; &#125;, function(err, comments) &#123;</span><br><span class="line">            if (err) return callback(err);</span><br><span class="line">            var attachImage &#x3D; function(comment, next) &#123;</span><br><span class="line">                ImageModel.findOne(&#123; _id: comment.image_id &#125;, function(err, image) &#123;</span><br><span class="line">                    if (err) throw err;</span><br><span class="line">                    comment.image &#x3D; image;</span><br><span class="line">                    next(err);</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            async.each(comments, attachImage, function(err) &#123;</span><br><span class="line">                if (err) throw err;</span><br><span class="line">                callback(err, comments);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>async.each 函数接受的三个参数如下：</p><ul><li>collection：用于接收异步操作的集合，这里是评论集；</li><li>iteratee：异步操作函数，这里是 attachImage 函数；</li><li>callback：全部操作执行完成的回调函数；</li></ul><p>然后将前面三个 helper 函数放到一起，创建一个 sidebar 模块，并发获取三个模块的数据。这里我们还是用 async.parallel 函数，因为三个模块本质上也是异步查询：<br>helpers/sidebars.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">const async &#x3D; require(&#39;async&#39;);</span><br><span class="line">const Stats &#x3D; require(&#39;.&#x2F;stats&#39;);</span><br><span class="line">const Images &#x3D; require(&#39;.&#x2F;images&#39;);</span><br><span class="line">const Comments &#x3D; require(&#39;.&#x2F;comments&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; function(viewModel, callback) &#123;</span><br><span class="line">    async.parallel(</span><br><span class="line">        [</span><br><span class="line">            function(next) &#123;</span><br><span class="line">                Stats(next);</span><br><span class="line">            &#125;,</span><br><span class="line">            function(next) &#123;</span><br><span class="line">                Images.popular(next);</span><br><span class="line">            &#125;,</span><br><span class="line">            function(next) &#123;</span><br><span class="line">                Comments.newest(next);</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        function(err, results) &#123;</span><br><span class="line">            viewModel.sidebar &#x3D; &#123;</span><br><span class="line">                stats: results[0],</span><br><span class="line">                popular: results[1],</span><br><span class="line">                comments: results[2]</span><br><span class="line">            &#125;</span><br><span class="line">            callback(viewModel);</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后将sidebar 模块用到 home 和 image 控制器中：<br>controllers/home.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const sidebar &#x3D; require(&#39;..&#x2F;helpers&#x2F;sidebar&#39;);</span><br><span class="line">const ImageModel &#x3D; require(&#39;..&#x2F;models&#x2F;image&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  index: function(req, res) &#123;</span><br><span class="line">    const viewModel &#x3D; &#123; images: [] &#125;;</span><br><span class="line"></span><br><span class="line">    ImageModel.find(&#123;&#125;, &#123;&#125;, &#123; sort: &#123; timestamp: -1 &#125; &#125;, function(err, images) &#123;</span><br><span class="line">      if (err) throw err;</span><br><span class="line">      viewModel.images &#x3D; images;</span><br><span class="line">      sidebar(viewModel, function(viewModel) &#123;</span><br><span class="line">        res.render(&#39;index&#39;, viewModel);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>controllers/image.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">const fs &#x3D; require(&#39;fs&#39;);</span><br><span class="line">const path &#x3D; require(&#39;path&#39;);</span><br><span class="line">const md5 &#x3D; require(&#39;md5&#39;);</span><br><span class="line">const sidebar &#x3D; require(&#39;..&#x2F;helpers&#x2F;sidebar&#39;);</span><br><span class="line">const ImageModel &#x3D; require(&#39;..&#x2F;models&#x2F;image&#39;);</span><br><span class="line">const CommentModel &#x3D; require(&#39;..&#x2F;models&#x2F;comment&#39;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    index: function(req, res) &#123;</span><br><span class="line">        const viewModel &#x3D; &#123; image: &#123;&#125;, comments: [] &#125;;</span><br><span class="line">        ImageModel.findOne(&#123; filename: &#123; $regex: req.params.image_id &#125; &#125;, function(err, image) &#123;</span><br><span class="line">          if (err) throw err;</span><br><span class="line">          if (image) &#123;</span><br><span class="line">            &#x2F;&#x2F; 增加该图片的访问量</span><br><span class="line">            image.views +&#x3D; 1;</span><br><span class="line">            viewModel.image &#x3D; image;</span><br><span class="line">            image.save();</span><br><span class="line"></span><br><span class="line">            CommentModel.find(</span><br><span class="line">              &#123; image_id: image._id &#125;,</span><br><span class="line">              &#123;&#125;,</span><br><span class="line">              &#123; sort: &#123; timestamp: 1 &#125; &#125;,</span><br><span class="line">              function(err, comments) &#123;</span><br><span class="line">                if (err) throw err;</span><br><span class="line">                viewModel.comments &#x3D; comments;</span><br><span class="line">                sidebar(viewModel, function(viewModel) &#123;</span><br><span class="line">                  res.render(&#39;image&#39;, viewModel);</span><br><span class="line">                &#125;)</span><br><span class="line">              &#125;</span><br><span class="line">            )</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            res.redirect(&#39;&#x2F;&#39;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    create: function(req, res) &#123;</span><br><span class="line">        var tempPath &#x3D; req.file.path;</span><br><span class="line">        var imgUrl &#x3D; req.file.filename;</span><br><span class="line">        var ext &#x3D; path.extname(req.file.originalname).toLowerCase();</span><br><span class="line">        var targetPath &#x3D; path.resolve(&#39;.&#x2F;public&#x2F;upload&#x2F;&#39; + imgUrl + ext);</span><br><span class="line"></span><br><span class="line">        if (ext &#x3D;&#x3D;&#x3D; &#39;.png&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.jpg&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.jpeg&#39; || ext &#x3D;&#x3D;&#x3D; &#39;.gif&#39;) &#123;</span><br><span class="line">          fs.rename(tempPath, targetPath, function(err) &#123;</span><br><span class="line">            if (err) throw err;</span><br><span class="line">            const newImg &#x3D; new ImageModel(&#123;</span><br><span class="line">              title: req.body.title,</span><br><span class="line">              description: req.body.description,</span><br><span class="line">              filename: imgUrl + ext</span><br><span class="line">            &#125;)</span><br><span class="line">            newImg.save(function(err, image) &#123;</span><br><span class="line">              if (err) throw err;</span><br><span class="line">              res.redirect(&#39;&#x2F;images&#x2F;&#39; + image.uniqueId);</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          fs.unlink(tempPath, function(err) &#123;</span><br><span class="line">            if (err) throw err;</span><br><span class="line">            res.json(500, &#123; error: &#39;只允许上传图片文件.&#39; &#125;);</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    like: function(req, res) &#123;</span><br><span class="line">        ImageModel.findOne(&#123; filename: &#123; $regex: req.params.image_id &#125; &#125;, function(err, image) &#123;</span><br><span class="line">          if (!err &amp;&amp; image) &#123;</span><br><span class="line">            image.likes +&#x3D; 1;</span><br><span class="line">            image.save(function(err) &#123;</span><br><span class="line">              if (err) res.json(err);</span><br><span class="line">              else res.json(&#123; likes: image.likes &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    remove: function(req, res) &#123;</span><br><span class="line">      ImageModel.findOne(&#123; filename: &#123; $regex: req.params.image_id &#125; &#125;, function(err, image) &#123;</span><br><span class="line">        if (err) throw err;</span><br><span class="line">        fs.unlink(path.resolve(&#39;.&#x2F;public&#x2F;upload&#x2F;&#39; + image.filename), function(err) &#123;</span><br><span class="line">          if (err) throw err;</span><br><span class="line">          CommentModel.remove(&#123; image_id: image._id &#125;, function(err) &#123;</span><br><span class="line">            image.remove(function(err) &#123;</span><br><span class="line">              if (!err) &#123;</span><br><span class="line">                res.json(true);</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                Response.json(false);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    comment: function(req, res) &#123;</span><br><span class="line">        ImageModel.findOne(&#123; filename: &#123; $regex: req.params.image_id &#125; &#125;, function(err, image) &#123;</span><br><span class="line">          if (!err &amp;&amp; image) &#123;</span><br><span class="line">            const newComment &#x3D; new CommentModel(req.body);</span><br><span class="line">            newComment.gravatar &#x3D; md5(newComment.email);</span><br><span class="line">            newComment.image_id &#x3D; image._id;</span><br><span class="line">            newComment.save(function(err, comment) &#123;</span><br><span class="line">              if (err) throw err;</span><br><span class="line">              res.redirect(&#39;&#x2F;images&#x2F;&#39; + image.uniqueId + &#39;#&#39; + comment._id);</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            res.redirect(&#39;&#x2F;&#39;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在我们来重新运行服务器看下侧边栏的数据有没有同步更新吧!</p><p>到这里我们今天要实现的功能已经全部实现了，你可以在这个的基础上自己再拓展。</p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> Brookliu</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://brookliu.xyz/2020/10/14/Express-MongoDB%E6%90%AD%E5%BB%BA%E5%9B%BE%E7%89%87%E5%88%86%E4%BA%AB%E7%A4%BE%E5%8C%BA%E4%BA%8C/" title="Express+MongoDB搭建图片分享社区二">https://brookliu.xyz/2020/10/14/Express-MongoDB搭建图片分享社区二/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Node/" rel="tag"><i class="fa fa-tag"></i> # Node</a><a href="/tags/Express/" rel="tag"><i class="fa fa-tag"></i> # Express</a><a href="/tags/MongoDB/" rel="tag"><i class="fa fa-tag"></i> # MongoDB</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2020/10/13/Express-MongoDB%E6%90%AD%E5%BB%BA%E5%9B%BE%E7%89%87%E5%88%86%E4%BA%AB%E7%A4%BE%E5%8C%BA%E4%B8%80/" rel="prev" title="Express+MongoDB搭建图片分享社区一"><i class="fa fa-chevron-left"></i> Express+MongoDB搭建图片分享社区一</a></div><div class="post-nav-item"> <a href="/2020/12/02/Typora-Vue%E4%B8%BB%E9%A2%98-Gitee%E5%9B%BE%E5%BA%8A%E8%BD%BB%E6%9D%BE%E5%86%99%E6%96%87%E7%AB%A0/" rel="next" title="Typora+Vue主题+Gitee图床轻松写文章">Typora+Vue主题+Gitee图床轻松写文章<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#图片上传功能"><span class="nav-number">2.</span> <span class="nav-text">图片上传功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#接入MongoDB数据库"><span class="nav-number">3.</span> <span class="nav-text">接入MongoDB数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运行过程中的问题"><span class="nav-number">4.</span> <span class="nav-text">运行过程中的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现评论功能"><span class="nav-number">5.</span> <span class="nav-text">实现评论功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现图片的点赞和删除"><span class="nav-number">6.</span> <span class="nav-text">实现图片的点赞和删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#完善用户界面"><span class="nav-number">7.</span> <span class="nav-text">完善用户界面</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Brookliu" src="/images/logo.png"><p class="site-author-name" itemprop="name">Brookliu</p><div class="site-description" itemprop="description">扶我起来，我还能写</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">65</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">18</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">22</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/liubrook" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;liubrook" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://juejin.im/user/588993964030574" title="掘金 → https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;588993964030574" rel="noopener" target="_blank"><i class="fa fa-spinner fa-fw"></i> 掘金</a></span><span class="links-of-author-item"><a href="https://blog.csdn.net/lqpf199681" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;lqpf199681" rel="noopener" target="_blank"><i class="fa fa-crossjairs fa-fw"></i> CSDN</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://www.zhangxinxu.com/" title="http:&#x2F;&#x2F;www.zhangxinxu.com&#x2F;" rel="noopener" target="_blank">张鑫旭</a></li><li class="links-of-blogroll-item"> <a href="http://www.alloyteam.com/nav/" title="http:&#x2F;&#x2F;www.alloyteam.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">Web前端导航</a></li><li class="links-of-blogroll-item"> <a href="http://ife.baidu.com/" title="http:&#x2F;&#x2F;ife.baidu.com&#x2F;" rel="noopener" target="_blank">百度前端技术学院</a></li><li class="links-of-blogroll-item"> <a href="http://wf.uisdc.com/cn/" title="http:&#x2F;&#x2F;wf.uisdc.com&#x2F;cn&#x2F;" rel="noopener" target="_blank">google前端开发基础</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright"> &copy; 2019 – <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-star"></i></span> <span class="author" itemprop="copyrightHolder">by 1024肥宅</span></div><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_uv">本站访客数:<span id="busuanzi_value_site_uv"></span></span></div><div class="addthis_inline_share_toolbox"><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5fb642a4fe3376d3" async="async"></script></div><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共140.5k字</span></div><div class="weixin-box"><div class="weixin-menu"><div class="weixin-hover"><div class="weixin-description">微信扫一扫，订阅本博客</div></div></div></div><style>#comments .veditor{min-height:10rem;background-image:url(https://gitee.com/wugenqiang/PictureBed/raw/master/CS-Notes/20200425091751.png);background-size:contain;background-repeat:no-repeat;background-position:right;background-color:rgba(255,255,255,0);resize:none}</style><script>
    //   自定义邮箱审核规则
    document.body.addEventListener('click', function(e) {
        if (e.target.classList.contains('vsubmit')) {
            const email = document.querySelector('input[type=email]');
            const nick = document.querySelector('input[name=nick]');
            const reg = /^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
            if (!email.value || !nick.value || !reg.test(email.value)) {
                const str = `<div class="valert text-center"><div class="vtext">请填写正确的昵称和邮箱！</div></div>`;
                const vmark = document.querySelector('.vmark');
                vmark.innerHTML = str;
                vmark.style.display = 'block';
                setTimeout(function() {
                    vmark.style.display = 'none';
                    vmark.innerHTML = '';
                }, 2500);
            }
        }
    })
</script><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"wdEmjy5T77AkIgiwj3VfoTD0-gzGzoHsz","app_key":"Q0n1AFSDoyYQsw7RI9eC1rfP","server_url":null,"security":true};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script></div></footer></div><script size="300" alpha="0.6" zindex="-1" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-ribbon@1/canvas-ribbon.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var o,n,e=document.getElementsByTagName("link");if(0<e.length)for(i=0;i<e.length;i++)"canonical"==e[i].rel.toLowerCase()&&e[i].href&&(o=e[i].href);n=o?o.split(":")[0]:window.location.protocol.split(":")[0],o||(o=window.location.href),function(){var e=o,i=document.referrer;if(!/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(e)){var t="https"===String(n).toLowerCase()?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";i?(t+="?r="+encodeURIComponent(document.referrer),e&&(t+="&l="+e)):e&&(t+="?l="+e),(new Image).src=t}}(window)}()</script><script src="/js/local-search.js"></script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'wdEmjy5T77AkIgiwj3VfoTD0-gzGzoHsz',
      appKey     : 'Q0n1AFSDoyYQsw7RI9eC1rfP',
      placeholder: "(。・∀・)ノ )",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-CN' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><script type="text/javascript" src="/js/clicklove.js"></script><script async>window.onload=function(){var e=document.createElement("script"),t=document.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.src="/sw-register.js?v="+Date.now(),t.parentNode.insertBefore(e,t)}</script></body></html>